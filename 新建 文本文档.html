<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>æŠ¢ç¥¨ & ä»·æ ¼ç›‘æ§ Â· é›†æˆæ¼”ç¤º</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#0f1218;
      --card:#161a22;
      --muted:#8b93a7;
      --text:#e9edf4;
      --primary:#52a8ff;
      --primary-ghost:#1f2a3e;
      --success:#1cc88a;
      --danger:#ff5d5d;
      --warning:#f6c23e;
      --border:#232936;
      --chip:#202535;
      --shadow:0 4px 18px rgba(0,0,0,.35);
      --radius:14px;
      --gap:18px;
      --focus:0 0 0 3px rgba(82,168,255,.35);
      --mono: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:radial-gradient(1200px 600px at 20% -10%, #1b2230 0%, rgba(27,34,48,0) 60%), var(--bg);
      color:var(--text);
      font: 14px/1.45 system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
    }
    a{color:var(--primary);text-decoration:none}
    .container{max-width:1100px;margin:24px auto;padding:0 20px 40px}
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      background:rgba(15,18,24,.65);
      border-bottom:1px solid var(--border);
    }
    .nav{
      max-width:1100px; margin:0 auto; padding:14px 20px; display:flex; align-items:center; gap:14px;
    }
    .nav .brand{font-weight:700; letter-spacing:.2px;}
    .tabs{margin-left:auto; display:flex; gap:8px;}
    .tab-btn{
      padding:8px 14px; border-radius:999px; border:1px solid var(--border); background:transparent; color:var(--text); cursor:pointer;
    }
    .tab-btn.active{background:var(--primary-ghost); border-color:#2c3a53; box-shadow:var(--focus)}
    .page{display:none; margin-top:18px;}
    .page.active{display:block}
    .grid{
      display:grid; grid-template-columns: 380px 1fr; gap:var(--gap);
    }
    .card{
      background:linear-gradient(180deg, #181d28 0%, #141925 100%);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }
    .card .hd{padding:14px 16px;border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between}
    .card .hd h3{margin:0;font-size:15px}
    .card .bd{padding:16px}
    .row{display:flex; gap:10px; margin-bottom:12px}
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    input,select{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:#0f1420; color:var(--text); outline:none;
    }
    input:focus{box-shadow:var(--focus)}
    .btn{
      padding:10px 14px; border-radius:10px; border:1px solid var(--border); background:#1a2333; color:var(--text); cursor:pointer;
    }
    .btn.primary{background:var(--primary-ghost); border-color:#2c3a53}
    .btn.success{background:#153328; border-color:#1f6149}
    .btn.danger{background:#3a1e21; border-color:#6a2a30}
    .btn:disabled{opacity:.55; cursor:not-allowed}
    .status-chip{
      display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:var(--chip); border:1px solid var(--border); font-size:12px;
    }
    .chip-ok{color:var(--success); border-color:#1f4d3d}
    .chip-warn{color:var(--warning); border-color:#4c4222}
    .chip-bad{color:var(--danger); border-color:#5a2a2a}
    .muted{color:var(--muted)}
    .mono{font-family:var(--mono)}
    .log{
      height:320px; overflow:auto; background:#0c1019; padding:12px; border-radius:12px; border:1px dashed #283044;
      font-family:var(--mono); font-size:12px; line-height:1.45;
    }
    .list{width:100%; border-collapse:separate; border-spacing:0 10px}
    .list thead th{font-size:12px; color:var(--muted); font-weight:600; text-align:left; padding:0 8px}
    .list tbody td{
      background:#121826; border-top:1px solid var(--border); border-bottom:1px solid var(--border);
      padding:10px 8px; vertical-align:middle;
    }
    .list tbody tr td:first-child{border-left:1px solid var(--border); border-top-left-radius:12px; border-bottom-left-radius:12px}
    .list tbody tr td:last-child{border-right:1px solid var(--border); border-top-right-radius:12px; border-bottom-right-radius:12px}
    .price-ok{color:var(--success)}
    .price-bad{color:var(--danger)}
    .pill{display:inline-block; padding:4px 8px; border-radius:999px; background:#1a2031; border:1px solid var(--border); font-size:12px}
    .toast{
      position:fixed; right:20px; bottom:20px; display:none; padding:12px 14px; border-radius:12px; background:#162033; border:1px solid var(--border); box-shadow:var(--shadow);
    }
    .toast.show{display:block; animation:fade 3s ease 1}
    @keyframes fade{0%{opacity:0; transform:translateY(6px)}10%{opacity:1; transform:none}80%{opacity:1}100%{opacity:0; transform:translateY(6px)}}
    /* modal */
    .modal-mask{
      position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index:50;
    }
    .modal{width:520px; max-width:92vw}
    .modal .bd p{margin:.5em 0}
    /* responsive small tweaks */
    @media (max-width:980px){
      .grid{grid-template-columns:1fr}
    }
    .help{
      font-size:12px; color:var(--muted); margin-top:6px;
    }
    .kbd{font-family:var(--mono); font-size:12px; background:#1a2233; border:1px solid var(--border); border-radius:6px; padding:2px 6px}
  </style>
</head>
<body>
  <header>
    <nav class="nav" aria-label="ä¸»å¯¼èˆª">
      <div class="brand">ğŸ« æŠ¢ç¥¨ & ğŸ’¹ ä»·æ ¼ç›‘æ§ Â· é›†æˆæ¼”ç¤º</div>
      <div class="tabs" role="tablist" aria-label="åŠŸèƒ½åˆ‡æ¢">
        <button class="tab-btn active" role="tab" aria-selected="true" data-tab="ticket">æŠ¢ç¥¨</button>
        <button class="tab-btn" role="tab" aria-selected="false" data-tab="price">ä»·æ ¼ç›‘æ§</button>
      </div>
    </nav>
  </header>

  <div class="container">
    <!-- æŠ¢ç¥¨é¡µ -->
    <section id="page-ticket" class="page active" aria-labelledby="tab-ticket">
      <div class="grid">
        <!-- å·¦ä¾§ï¼šè¾“å…¥ -->
        <div class="card" aria-live="polite">
          <div class="hd">
            <h3>æŠ¢ç¥¨å‚æ•°</h3>
            <span id="ticket-status-chip" class="status-chip chip-warn">â³ æœªå¯åŠ¨</span>
          </div>
          <div class="bd">
            <div class="row">
              <div style="flex:1">
                <label for="targetName">ç›®æ ‡åç§°ï¼ˆå¦‚â€œæŸæŸæ¼”å”±ä¼šâ€ï¼‰</label>
                <input id="targetName" placeholder="è¯·è¾“å…¥ç›®æ ‡åç§°" autocomplete="off">
              </div>
            </div>
            <div class="row">
              <div style="flex:1">
                <label for="sessionName">åœºæ¬¡/ç¥¨æ¡£</label>
                <input id="sessionName" placeholder="å¦‚ï¼šä¸Šæµ·ç«™ 2025-09-01 19:30">
              </div>
            </div>
            <div class="row">
              <div style="flex:1">
                <label for="startTime">å¼€å§‹æ—¶é—´</label>
                <input id="startTime" type="datetime-local">
                <div class="help">åˆ°è¾¾å¼€å§‹æ—¶é—´è‡ªåŠ¨è¿›å…¥æŠ¢ç¥¨è½®è¯¢ï¼›å€’è®¡æ—¶æ¯ç§’åˆ·æ–°ã€‚</div>
              </div>
            </div>
            <div class="row">
              <button id="btnStartTicket" class="btn primary">ğŸš€ å¯åŠ¨æŠ¢ç¥¨</button>
              <button id="btnStopTicket" class="btn danger" disabled>ğŸ›‘ åœæ­¢æŠ¢ç¥¨</button>
            </div>
            <div class="row">
              <span class="pill">å€’è®¡æ—¶ï¼š<span id="countdown" class="mono">--:--:--</span></span>
              <span class="pill">åº“å­˜ï¼š<span id="stockLabel" class="mono">--</span></span>
            </div>
            <div class="help">æç¤ºï¼šé¦–æ¬¡ç‚¹å‡»æŒ‰é’®ä¼šè¢«æµè§ˆå™¨è§†ä¸ºâ€œç”¨æˆ·æ‰‹åŠ¿â€ï¼Œåç»­æ‰èƒ½æ’­æ”¾æé†’éŸ³ã€‚</div>

            <!-- â˜…â˜…â˜… é›†æˆå…¥å£ï¼ˆæŠ¢ç¥¨é¡¹ç›®è„šæœ¬æ³¨å…¥ï¼‰ â˜…â˜…â˜…
              ä¾‹å¦‚ï¼š
              <script src="https://cdn.example.com/ticket-project.bundle.js"></script>
              // å¹¶åœ¨ window.TicketProject ä¸­æš´éœ² APIï¼šstart(params), stop(), on(event, cb)
            -->
          </div>
        </div>

        <!-- å³ä¾§ï¼šçŠ¶æ€/æ—¥å¿— -->
        <div class="card">
          <div class="hd">
            <h3>å®æ—¶çŠ¶æ€ä¸æ—¥å¿—</h3>
            <div>
              <span class="pill">è½®è¯¢ï¼š<span id="pollBadge" class="mono muted">æœªå¼€å§‹</span></span>
            </div>
          </div>
          <div class="bd">
            <div class="row" style="gap:14px">
              <span class="status-chip chip-warn" id="liveStatus">ğŸŸ¡ å¾…å¼€å§‹</span>
              <span class="status-chip chip-ok" id="gotStatus" style="display:none">ğŸŸ¢ å·²æŠ¢åˆ°ç¥¨</span>
              <span class="status-chip chip-bad" id="noStockStatus" style="display:none">ğŸ”´ åº“å­˜ä¸è¶³</span>
            </div>
            <div id="log" class="log" aria-live="polite" aria-label="æŠ¢ç¥¨å®æ—¶æ—¥å¿—"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- ä»·æ ¼ç›‘æ§é¡µ -->
    <section id="page-price" class="page" aria-labelledby="tab-price">
      <div class="card">
        <div class="hd">
          <h3>æ·»åŠ ç›‘æ§</h3>
          <span class="muted">å½“ä»·æ ¼ä½äºé˜ˆå€¼æ—¶å¼¹çª— + å£°éŸ³æé†’</span>
        </div>
        <div class="bd">
          <div class="row">
            <div style="flex:2">
              <label for="itemUrl">å•†å“/è½¦ç¥¨é“¾æ¥</label>
              <input id="itemUrl" placeholder="https://example.com/item/123">
            </div>
            <div style="flex:1">
              <label for="priceThreshold">é˜ˆå€¼ï¼ˆå…ƒï¼‰</label>
              <input id="priceThreshold" type="number" min="0" step="1" placeholder="å¦‚ 500">
            </div>
          </div>
          <div class="row">
            <button id="btnAddWatch" class="btn success">â• æ·»åŠ ç›‘æ§</button>
          </div>
          <div class="help">
            â€¢ å½“å‰ä»·æ ¼æ¯ 10 ç§’åˆ·æ–°ï¼›æ”¯æŒæš‚åœ/æ¢å¤ä¸åˆ é™¤ã€‚<br>
            â€¢ ä»·æ ¼é¢œè‰²ï¼š<span class="price-ok">ç»¿è‰² = ä½äºé˜ˆå€¼</span>ï¼Œ<span class="price-bad">çº¢è‰² = é«˜äºé˜ˆå€¼</span>ã€‚<br>
            â€¢ é“¾æ¥æ ¼å¼æ ¡éªŒå¤±è´¥ä¼šæç¤ºâ€œé“¾æ¥æ— æ•ˆâ€ã€‚
          </div>

          <!-- â˜…â˜…â˜… é›†æˆå…¥å£ï¼ˆä»·æ ¼ç›‘æ§é¡¹ç›® APIï¼‰ â˜…â˜…â˜…
            å‡è®¾å¼€æºé¡¹ç›®æä¾› HTTP æˆ– JS æ¥å£ï¼š
            - JSï¼šwindow.PriceSDK.getCurrentPrice(url) -> Promise<number>
            - HTTPï¼šfetch('https://api.example.com/price?url=' + encodeURIComponent(url))
            è§ä¸‹æ–¹ fetchCurrentPrice() çš„â€œTODOï¼šæ›¿æ¢ä¸ºçœŸå®æ¥å£â€éƒ¨åˆ†ã€‚
          -->
        </div>
      </div>

      <div class="card" style="margin-top:18px">
        <div class="hd">
          <h3>ç›‘æ§åˆ—è¡¨</h3>
          <span class="pill">æ€»æ•°ï¼š<span id="watchCount" class="mono">0</span></span>
        </div>
        <div class="bd">
          <table class="list" aria-label="ä»·æ ¼ç›‘æ§åˆ—è¡¨">
            <thead>
              <tr>
                <th>åç§°/é“¾æ¥</th>
                <th>é˜ˆå€¼(Â¥)</th>
                <th>å½“å‰ä»·æ ¼(Â¥)</th>
                <th>çŠ¶æ€</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="watchTbody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <!-- å¼¹çª— -->
  <div id="modalMask" class="modal-mask" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="card modal">
      <div class="hd">
        <h3 id="modalTitle">æé†’</h3>
        <button class="btn" id="modalClose">âœ–</button>
      </div>
      <div class="bd" id="modalBody"></div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script>
    /**************
     * å·¥å…·å‡½æ•°åŒº *
     **************/
    const $ = (q)=>document.querySelector(q);
    const $$ = (q)=>document.querySelectorAll(q);
    const logEl = $("#log");

    function toast(msg){
      const t = $("#toast");
      t.textContent = msg;
      t.classList.add("show");
      setTimeout(()=> t.classList.remove("show"), 2600);
    }

    // ç®€å•å¯å¤ç”¨çš„ beepï¼ˆWebAudioï¼‰
    let audioCtx;
    function beep(duration=450, freq=880){
      try{
        audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.connect(g); g.connect(audioCtx.destination);
        o.type = "sine"; o.frequency.value = freq;
        o.start();
        g.gain.setValueAtTime(0.001, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.4, audioCtx.currentTime + 0.02);
        g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration/1000);
        o.stop(audioCtx.currentTime + duration/1000 + 0.05);
      }catch(e){ /* é™é»˜å¤±è´¥ï¼ˆæ¯”å¦‚æœªæœ‰ç”¨æˆ·æ‰‹åŠ¿ï¼‰ */ }
    }

    function openModal(html){
      $("#modalBody").innerHTML = html;
      $("#modalMask").style.display = "flex";
    }
    function closeModal(){
      $("#modalMask").style.display = "none";
    }
    $("#modalClose").addEventListener("click", closeModal);
    $("#modalMask").addEventListener("click", (e)=>{ if(e.target.id==="modalMask") closeModal(); });

    function appendLog(line){
      const time = new Date().toLocaleTimeString();
      logEl.insertAdjacentHTML("afterbegin", `<div><span class="muted">[${time}]</span> ${line}</div>`);
    }

    function formatCountdown(ms){
      if(ms<=0) return "00:00:00";
      const s = Math.floor(ms/1000);
      const h = String(Math.floor(s/3600)).padStart(2,"0");
      const m = String(Math.floor((s%3600)/60)).padStart(2,"0");
      const ss= String(s%60).padStart(2,"0");
      return `${h}:${m}:${ss}`;
    }

    // ç®€å• URL æ ¡éªŒ
    function isValidUrl(u){
      try{ new URL(u); return true; }catch{ return false; }
    }

    /*************************
     * é¡µç­¾åˆ‡æ¢ï¼ˆæŠ¢ç¥¨/ä»·æ ¼ç›‘æ§ï¼‰
     *************************/
    $$(".tab-btn").forEach(btn=>{
      btn.addEventListener("click",()=>{
        $$(".tab-btn").forEach(b=>b.classList.toggle("active", b===btn));
        $$(".page").forEach(p=>p.classList.remove("active"));
        const id = btn.dataset.tab;
        document.querySelector(`#page-${id}`).classList.add("active");
      });
    });

    /*****************
     * æŠ¢ç¥¨æ¨¡å—é€»è¾‘  *
     *****************/
    const ticket = {
      timerId: null,
      pollId: null,
      countdownId: null,
      started: false,
      start(){
        const name = $("#targetName").value.trim();
        const session = $("#sessionName").value.trim();
        const startTime = $("#startTime").value;
        if(!name){ toast("ç›®æ ‡åç§°ä¸èƒ½ä¸ºç©º"); return; }
        if(!session){ toast("åœºæ¬¡ä¸èƒ½ä¸ºç©º"); return; }
        if(!startTime){ toast("å¼€å§‹æ—¶é—´ä¸èƒ½ä¸ºç©º"); return; }
        const startAt = new Date(startTime).getTime();
        if(isNaN(startAt)){ toast("å¼€å§‹æ—¶é—´æ ¼å¼æ— æ•ˆ"); return; }

        this.started = true;
        $("#btnStartTicket").disabled = true;
        $("#btnStopTicket").disabled = false;
        $("#ticket-status-chip").className = "status-chip chip-ok";
        $("#ticket-status-chip").textContent = "âœ… å·²å¯åŠ¨";
        $("#liveStatus").textContent = "ğŸŸ¢ ç›‘æ§ä¸­";
        $("#gotStatus").style.display = "none";
        $("#noStockStatus").style.display = "none";
        $("#pollBadge").textContent = "å·²å°±ç»ª";
        appendLog(`å¯åŠ¨æŠ¢ç¥¨ï¼š${name}ï½œ${session}ã€‚å¼€å§‹æ—¶é—´ï¼š${startTime}`);

        // å€’è®¡æ—¶
        clearInterval(this.countdownId);
        this.countdownId = setInterval(()=>{
          const now = Date.now();
          const left = startAt - now;
          $("#countdown").textContent = formatCountdown(left);
          if(left<=0){
            clearInterval(this.countdownId);
            $("#countdown").textContent = "00:00:00";
            appendLog("åˆ°è¾¾å¼€å§‹æ—¶é—´ï¼Œè¿›å…¥æŠ¢ç¥¨è½®è¯¢â€¦");
            this.beginPolling(name, session);
          }
        }, 1000);

        // å…è®¸åœ¨æœªåˆ°æ—¶é‡å¤å±•ç¤ºå€’è®¡æ—¶
        $("#stockLabel").textContent = "--";
      },
      stop(reason="æ‰‹åŠ¨åœæ­¢"){
        this.started = false;
        clearInterval(this.pollId);
        clearInterval(this.countdownId);
        $("#btnStartTicket").disabled = false;
        $("#btnStopTicket").disabled = true;
        $("#ticket-status-chip").className = "status-chip chip-warn";
        $("#ticket-status-chip").textContent = "â¸ å·²åœæ­¢";
        $("#liveStatus").textContent = "ğŸŸ¡ å·²åœæ­¢";
        $("#pollBadge").textContent = "æœªå¼€å§‹";
        appendLog(`åœæ­¢æŠ¢ç¥¨ï¼š${reason}`);
      },
      beginPolling(name, session){
        // æ¯ 3 ç§’æ‹‰ä¸€æ¬¡åº“å­˜çŠ¶æ€
        $("#pollBadge").textContent = "3s";
        // â˜…â˜…â˜… é›†æˆå…¥å£ï¼ˆè°ƒç”¨â€œæŠ¢ç¥¨é¡¹ç›®â€çš„å¼€å§‹å‡½æ•°ï¼‰â˜…â˜…â˜…
        // ä¾‹å¦‚ï¼š
        // window.TicketProject.start({ target:name, session, onUpdate: (evt)=>{ appendLog(evt.message) } });
        // å¹¶åœ¨ this.pollId å†…éƒ¨è°ƒç”¨ TicketProject.checkStock() æˆ–ç”±å¯¹æ–¹åº“è‡ªè¡Œè½®è¯¢ã€‚
        // ä¸‹æ–¹ä¸ºã€æ¨¡æ‹Ÿå®ç°ã€‘ï¼Œè¯·æ›¿æ¢ä¸ºçœŸå®é€»è¾‘ã€‚

        let attempts = 0;
        clearInterval(this.pollId);
        this.pollId = setInterval(()=>{
          attempts++;
          const stock = mockCheckStock(); // â† æ¨¡æ‹Ÿåº“å­˜
          $("#stockLabel").textContent = stock;
          appendLog(`åº“å­˜æ£€æŸ¥ #${attempts}ï¼š${stock}`);
          if(stock === 0 && attempts % 3 === 0){
            $("#noStockStatus").style.display = "inline-flex";
          }
          // éšæœºâ€œæŠ¢åˆ°ç¥¨â€æ¡ä»¶ï¼ˆç¤ºä¾‹ï¼‰
          if(stock > 0 && Math.random() < 0.22){
            clearInterval(this.pollId);
            $("#gotStatus").style.display = "inline-flex";
            $("#liveStatus").textContent = "ğŸŸ¢ å·²æŠ¢åˆ°ç¥¨";
            appendLog("ğŸ‰ æŠ¢ç¥¨æˆåŠŸï¼è¯·å°½å¿«å‰å¾€æ”¯ä»˜ã€‚");
            beep(650, 940);
            openModal(`<p>ğŸ‰ <strong>å·²æŠ¢åˆ°ç¥¨</strong></p >
              <p>ç›®æ ‡ï¼š<span class="mono">${name}</span></p >
              <p>åœºæ¬¡ï¼š<span class="mono">${session}</span></p >
              <p class="muted">è¯·åœ¨å¹³å°è§„å®šæ—¶é—´å†…å®Œæˆæ”¯ä»˜ã€‚</p >`);
            // â˜…â˜…â˜… é›†æˆå…¥å£ï¼ˆè°ƒç”¨â€œæŠ¢ç¥¨é¡¹ç›®â€çš„åœæ­¢/æ¸…ç†ï¼‰â˜…â˜…â˜…
            // window.TicketProject.stop?.();
            $("#btnStartTicket").disabled = false;
            $("#btnStopTicket").disabled = true;
            $("#ticket-status-chip").textContent = "ğŸ¯ å·²å®Œæˆ";
            $("#ticket-status-chip").className = "status-chip chip-ok";
          }
        }, 3000);
      }
    };

    // ç»‘å®šæŒ‰é’®
    $("#btnStartTicket").addEventListener("click", ()=> ticket.start());
    $("#btnStopTicket").addEventListener("click", ()=> ticket.stop());

    // â€”â€” æ¨¡æ‹Ÿåº“å­˜ï¼šæœ‰æ—¶ 0ã€æœ‰æ—¶ 1-5 â€”â€”ï¼ˆé›†æˆçœŸå®é¡¹ç›®æ—¶åˆ é™¤ï¼‰
    function mockCheckStock(){
      const r = Math.random();
      if(r < 0.55) return 0;
      if(r < 0.85) return Math.floor(1 + Math.random()*2);
      return Math.floor(3 + Math.random()*3);
    }

    /*********************
     * ä»·æ ¼ç›‘æ§æ¨¡å—é€»è¾‘  *
     *********************/
    const watches = []; // {id,url,threshold,active,name,currentPrice, timerId}

    const tbody = $("#watchTbody");
    function renderWatches(){
      $("#watchCount").textContent = String(watches.length);
      tbody.innerHTML = "";
      for(const w of watches){
        const priceCls = (typeof w.currentPrice==="number" && w.currentPrice <= w.threshold) ? "price-ok" : "price-bad";
        const status = w.active ? "ç›‘æ§ä¸­" : "å·²æš‚åœ";
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>
            <div class="mono" style="max-width:560px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap" title="${w.url}">
              ${w.name || new URL(w.url).hostname}
            </div>
            <div class="muted mono" style="max-width:560px; overflow:hidden; text-overflow:ellipsis">${w.url}</div>
          </td>
          <td class="mono">${w.threshold}</td>
          <td class="mono ${priceCls}">${(w.currentPrice ?? "--")}</td>
          <td><span class="pill">${status}</span></td>
          <td>
            <button class="btn" data-act="toggle" data-id="${w.id}">${w.active?"æš‚åœ":"æ¢å¤"}</button>
            <button class="btn danger" data-act="del" data-id="${w.id}">åˆ é™¤</button>
            <button class="btn" data-act="refresh" data-id="${w.id}">ç«‹å³åˆ·æ–°</button>
          </td>
        `;
        tbody.appendChild(row);
      }
    }

    function addWatch(){
      const url = $("#itemUrl").value.trim();
      const threshold = Number($("#priceThreshold").value);
      if(!url || !isValidUrl(url)){ toast("é“¾æ¥æ— æ•ˆ"); return; }
      if(!Number.isFinite(threshold) || threshold<=0){ toast("é˜ˆå€¼éœ€è¦ä¸ºæ­£æ•°"); return; }
      const id = Date.now().toString(36) + Math.random().toString(36).slice(2,7);
      const name = safeInferName(url);
      const w = { id, url, threshold, active:true, name, currentPrice: undefined, timerId:null };
      watches.unshift(w);
      renderWatches();
      toast("å·²æ·»åŠ ç›‘æ§");
      scheduleWatch(w);
      // æ¸…ç†è¾“å…¥
      $("#itemUrl").value = ""; $("#priceThreshold").value = "";
    }

    $("#btnAddWatch").addEventListener("click", addWatch);

    // æ¨æ–­åç§°ï¼ˆå¯è‡ªå·±æ”¹é€ ï¼‰
    function safeInferName(u){
      try{
        const url = new URL(u);
        const path = url.pathname.split("/").filter(Boolean).slice(-1)[0] || url.hostname;
        return decodeURIComponent(path).slice(0,60);
      }catch{ return u; }
    }

    // ç»‘å®šè¡¨æ ¼æ“ä½œ
    tbody.addEventListener("click", async (e)=>{
      const btn = e.target.closest("button[data-act]");
      if(!btn) return;
      const id = btn.dataset.id;
      const act = btn.dataset.act;
      const w = watches.find(x=>x.id===id);
      if(!w) return;

      if(act==="toggle"){
        w.active = !w.active;
        if(w.active){ scheduleWatch(w); toast("å·²æ¢å¤ç›‘æ§"); }
        else{ clearInterval(w.timerId); w.timerId=null; toast("å·²æš‚åœ"); }
        renderWatches();
      }else if(act==="del"){
        if(w.timerId) clearInterval(w.timerId);
        const idx = watches.findIndex(x=>x.id===id);
        watches.splice(idx,1);
        renderWatches();
        toast("å·²åˆ é™¤");
      }else if(act==="refresh"){
        await refreshPrice(w, /*silent*/false);
      }
    });

    // ä¸ºå•æ¡ç›‘æ§å®‰æ’è½®è¯¢ï¼ˆæ¯ 10sï¼‰
    function scheduleWatch(w){
      clearInterval(w.timerId);
      const doRefresh = ()=> refreshPrice(w, /*silent*/true);
      doRefresh();
      w.timerId = setInterval(doRefresh, 10000);
    }

    async function refreshPrice(w, silent=true){
      if(!w.active) return;
      try{
        // â˜…â˜…â˜… é›†æˆå…¥å£ï¼ˆè°ƒç”¨â€œä»·æ ¼ç›‘æ§é¡¹ç›®â€çš„è·å–ä»·æ ¼æ¥å£ï¼‰â˜…â˜…â˜…
        // TODOï¼šå°†ä¸‹è¡Œæ›¿æ¢ä¸ºçœŸå®æ¥å£ï¼ˆJS SDK æˆ– HTTPï¼‰ï¼Œå¹¶å¤„ç†å¼‚å¸¸ä¸è¿”å›ç»“æ„ã€‚
        // ä¾‹å¦‚ï¼š
        // const price = await window.PriceSDK.getCurrentPrice(w.url);
        // æˆ–ï¼š
        // const resp = await fetch("https://api.example.com/price?url=" + encodeURIComponent(w.url));
        // const {price} = await resp.json();

        const price = await mockFetchCurrentPrice(w.url); // â† æ¨¡æ‹Ÿ

        w.currentPrice = price;
        // è¾¾æ ‡æé†’
        if(price <= w.threshold){
          // å¼¹çª— + å£°éŸ³
          beep(700, 1020);
          openModal(`
            <p>ğŸ“‰ <strong>ä»·æ ¼è¾¾æ ‡</strong></p >
            <p>åç§°ï¼š<span class="mono">${w.name}</span></p >
            <p>å½“å‰ä»·æ ¼ï¼š<span class="mono price-ok">Â¥${price}</span>ï¼ˆé˜ˆå€¼ Â¥${w.threshold}ï¼‰</p >
            <p class="muted">è¯·å°½å¿«å‰å¾€é¡µé¢æŸ¥çœ‹ã€‚</p >
          `);
        }
        if(!silent) toast("å·²åˆ·æ–°ä»·æ ¼");
      }catch(err){
        console.error(err);
        if(!silent) toast("åˆ·æ–°å¤±è´¥");
      }finally{
        renderWatches();
      }
    }

    // â€”â€” æ¨¡æ‹Ÿä»·æ ¼æ¥å£ â€”â€”ï¼ˆé›†æˆçœŸå®é¡¹ç›®æ—¶åˆ é™¤ï¼‰
    async function mockFetchCurrentPrice(url){
      await new Promise(r=>setTimeout(r, 300 + Math.random()*400));
      // ç”¨ hostname ç¨å¾®â€œç¨³å®šåŒ–â€ä¸€ä¸‹éšæœºå€¼
      const base = [...(new URL(url).hostname)].reduce((a,c)=>a+c.charCodeAt(0), 0);
      const n = (base % 800) + Math.random()*120; // çº¦ 0~920
      return Math.round(n);
    }

    /*****************
     * æ— éšœç¢ & åˆå§‹åŒ– *
     *****************/
    appendLog("æ¬¢è¿ä½¿ç”¨ï¼šæ­¤é¡µé¢ä»…ä¸ºå­¦ä¹ ç ”ç©¶çš„å‰ç«¯é›†æˆç¤ºä¾‹ã€‚è¯·éµå®ˆå¹³å°ä¸æ³•å¾‹æ³•è§„ï¼Œå‹¿ç”¨äºè¿è§„æŠ¢ç¥¨æˆ–æ¶æ„ç›‘æ§ã€‚");
  </script>
</body>
</html>